import React, { useState, useCallback, useEffect, useRef } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, increment, onSnapshot } from 'firebase/firestore';

// --- Global Constants ---
const MODEL_NAME_FLASH = "gemini-2.5-flash-preview-09-2025";
const API_KEY = ""; // Ú©Ù„ÛŒÙ„Û•Ú©Û• Ù„ÛØ±Û• Ø¬ÛÚ¯ÛŒØ± Ø¯Û•Ú©Ø±ÛØª
const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";

// Ø¨Û•Ø³ØªÛ•Ø±ÛŒ ÙˆÛÙ†Û•ÛŒ Ø¦Ø§ÛŒÚ©Û†Ù†Û•Ú©Û• (ØªÛ•Ù†Ù‡Ø§ Ø¨Û† ØªØ§Ø¨ÛŒ Ø¨Ú•Ø§ÙˆØ³Û•Ø± Ùˆ Ø³Û†Ø´ÛŒØ§Úµ Ù…ÛŒØ¯ÛŒØ§)
const APP_ICON_URL = "https://i.ibb.co/zhGP9H13/IMG-1261.png";

// --- Design Constants ---
const PRIMARY_COLOR = 'bg-teal-700';
const VIEW_CONFIG = {
  qa: { textKey: 'tab_qa', icon: 'ğŸ’¬', button: 'bg-sky-500 hover:bg-sky-600' },
  drug: { textKey: 'tab_drug', icon: 'ğŸ’Š', button: 'bg-emerald-500 hover:bg-emerald-600' },
  lab: { textKey: 'tab_lab', icon: 'ğŸ”¬', button: 'bg-indigo-500 hover:bg-indigo-600' },
  pregnancy: { textKey: 'tab_pregnancy', icon: 'ğŸ¤°', button: 'bg-amber-500 hover:bg-amber-600' },
  doctors: { textKey: 'tab_doctors', icon: 'ğŸ‘¨â€âš•ï¸', button: 'bg-rose-500 hover:bg-rose-600' },
  donation: { textKey: 'tab_donation', icon: 'â¤ï¸', button: 'bg-red-500 hover:bg-red-600' },
};

const UI_TEXT = {
  ku: {
    app_title: "iDoctors",
    tab_qa: "Ú¯ÙØªÙˆÚ¯Û† (AI)",
    tab_drug: "Ø¯Û•Ø±Ù…Ø§Ù†",
    tab_lab: "ÙÛ•Ø­Ø³ (AI)",
    tab_pregnancy: "Ø¯ÙˆÙˆÚ¯ÛŒØ§Ù†ÛŒ",
    tab_doctors: "Ø¯Ú©ØªÛ†Ø±Û•Ú©Ø§Ù†",
    tab_donation: "Ø¨Û•Ø®Ø´ÛŒÙ†",
    drug_search_title: "Ù†Ø§ÙˆÛŒ Ø¯Û•Ø±Ù…Ø§Ù†Û•Ú©Ø§Ù†",
    drug_pharmacy_title: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ø¯Û•Ø±Ù…Ø§Ù†Ø®Ø§Ù†Û•Ú©Ø§Ù†",
    drug_rx_title: "Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú•Û•Ú†Û•ØªÛ•",
    lab_analyze_title: "Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙÛ•Ø­Ø³ (AI)",
    lab_prompt: "ÙˆÛÙ†Û•ÛŒ ÙÛ•Ø­Ø³Û•Ú©Û• Ù„ÛØ±Û• Ø¯Ø§Ø¨Ù†Û Ø¨Û† Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ØªÛ•ÙˆØ§Ùˆ",
    lab_address_title: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ ØªØ§Ù‚ÛŒÚ¯Û•Ú©Ø§Ù†",
    lab_address_status: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ù‡Û•Ø±Ø²Ø§Ù†ØªØ±ÛŒÙ† ØªØ§Ù‚ÛŒÚ¯Û•ÛŒÛ•Ú©Ø§Ù† Ø¨Û•Ù… Ø²ÙˆØ§Ù†Û• Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ø¨ÛŒØª",
    preg_weeks_title: "Ù‡Û•ÙØªÛ•Ú©Ø§Ù†ÛŒ Ø¯ÙˆÙˆÚ¯ÛŒØ§Ù†ÛŒ (AI)",
    preg_gender_title: "Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•Û•Ú¯Û•Ø² (AI)",
    preg_date_placeholder: "Ú•ÛÚ©Û•ÙˆØªÛŒ Ú©Û†ØªØ§ Ø³ÙˆÙˆÚ•ÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û• Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•",
    preg_weeks_btn: "Ù‡Û•Ú˜Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù‡Û•ÙØªÛ•Ú©Ø§Ù† Ùˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ",
    preg_gender_btn: "Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•Û•Ú¯Û•Ø²",
    docs_search_title: "Ú¯Û•Ú•Ø§Ù† Ø¨Û•Ø¯ÙˆØ§ÛŒ Ø¯Ú©ØªÛ†Ø±",
    docs_placeholder: "Ù†Ø§ÙˆÛŒ Ø¯Ú©ØªÛ†Ø± ÛŒØ§Ù† Ù¾Ø³Ù¾Û†Ú•ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•...",
    docs_btn: "Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù¾Ø²ÛŒØ´Ú© âœ¨",
    docs_online_title: "Ø¯Ú©ØªÛ†Ø±ÛŒ Ø¦Û†Ù†Ù„Ø§ÛŒÙ† (AI)",
    docs_booking_title: "Ù†Û†Ø±Û•Ú¯Ø±ØªÙ†",
    docs_booking_status: "Ø¨Û• Ø²ÙˆÙˆØªØ±ÛŒÙ† Ú©Ø§Øª Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ø¨ÛØª",
    placeholder_drug: "Ù†Ø§ÙˆÛŒ Ø¯Û•Ø±Ù…Ø§Ù†Û•Ú©Û• Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•...",
    pharmacy_status: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ù‡Û•Ø±Ø²Ø§Ù†ØªØ±ÛŒÙ† Ø¯Û•Ø±Ù…Ø§Ù†Ø®Ø§Ù†Û•Ú©Ø§Ù† Ø¨Û•Ù… Ø²ÙˆÙˆØ§Ù†Û• Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ø¨ÛØª...",
    rx_prompt: "ÙˆÛÙ†Û•ÛŒ Ú•Û•Ú†Û•ØªÛ•Ú©Û• Ù„ÛØ±Û• Ø¯Ø§Ø¨Ù†Û",
    loading: "ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•Û Ø¨Û•...",
    error: "Ù‡Û•ÚµÛ•ÛŒÛ•Ú© Ú•ÙˆÙˆÛŒØ¯Ø§ Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ú©Ø±Ø¯Ù†.",
    disclaimer: "ØªÛØ¨ÛŒÙ†ÛŒ: Ø¦Û•Ù… Ø¦Û•Ù¾Ù„ÛŒÚ©Û•ÛŒØ´Ù†Û• ØªÛ•Ù†Ù‡Ø§ Ø¨Û† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ• Ùˆ Ø¬ÛÚ¯Ø±Û•ÙˆÛ•ÛŒ Ú•Ø§ÙˆÛÚ˜ÛŒ Ù¾Ø²ÛŒØ´Ú©ÛŒ Ù†ÛŒÛŒÛ•.",
    visitor_count_label: "Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†ÛŒÚ©Û•Ø±Ø§Ù†:",
  },
  ar: {
    app_title: "iDoctors",
    tab_qa: "Ø¯Ø±Ø¯Ø´Ø© (AI)",
    tab_drug: "Ø§Ù„Ø£Ø¯ÙˆÙŠØ©",
    tab_lab: "Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ (AI)",
    tab_pregnancy: "Ø§Ù„Ø­Ù…Ù„",
    tab_doctors: "Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡",
    tab_donation: "Ø§Ù„ØªØ¨Ø±Ø¹",
    drug_search_title: "Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©",
    drug_pharmacy_title: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª",
    drug_rx_title: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©",
    lab_analyze_title: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ (AI)",
    lab_prompt: "Ø¶Ø¹ ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„",
    lab_address_title: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª",
    lab_address_status: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ø±Ø®Øµ Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹",
    preg_weeks_title: "Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø­Ù…Ù„ (AI)",
    preg_gender_title: "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³ (AI)",
    preg_date_placeholder: "Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ©",
    preg_weeks_btn: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
    preg_gender_btn: "Ø£ÙˆÙ‚Ø§Øª ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³",
    docs_search_title: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨ÙŠØ¨",
    docs_placeholder: "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØµØ§Øµ...",
    docs_btn: "Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨ÙŠØ¨ âœ¨",
    docs_online_title: "Ø·Ø¨ÙŠØ¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (AI)",
    docs_booking_title: "Ø§Ù„Ø­Ø¬Ø²",
    docs_booking_status: "Ø³ÙŠØªÙˆÙØ± ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†",
    placeholder_drug: "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù‡Ù†Ø§...",
    pharmacy_status: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ø±Ø®Øµ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹...",
    rx_prompt: "Ø¶Ø¹ ØµÙˆØ±Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© Ù‡Ù†Ø§",
    loading: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...",
    error: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.",
    disclaimer: "Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ©.",
    visitor_count_label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±:",
  },
  en: {
    app_title: "iDoctors",
    tab_qa: "Chat (AI)",
    tab_drug: "Medicine",
    tab_lab: "Lab Test (AI)",
    tab_pregnancy: "Pregnancy",
    tab_doctors: "Doctors",
    tab_donation: "Donation",
    drug_search_title: "Medicine Names",
    drug_pharmacy_title: "Pharmacy Addresses",
    drug_rx_title: "Read Prescription",
    lab_analyze_title: "Analyze Lab (AI)",
    lab_prompt: "Drop lab image here for full analysis",
    lab_address_title: "Lab Addresses",
    lab_address_status: "Cheapest lab addresses will be available soon",
    preg_weeks_title: "Pregnancy Weeks (AI)",
    preg_gender_title: "Gender Detection (AI)",
    preg_date_placeholder: "Select last menstrual period date",
    preg_weeks_btn: "Calculate Weeks & Info",
    preg_gender_btn: "Gender Detection Times",
    docs_search_title: "Search for Doctor",
    docs_placeholder: "Enter doctor name or specialty...",
    docs_btn: "Search for Doctor âœ¨",
    docs_online_title: "Online Doctor (AI)",
    docs_booking_title: "Booking",
    docs_booking_status: "Will be available soon",
    placeholder_drug: "Enter medicine name here...",
    pharmacy_status: "Cheapest pharmacy addresses will be available soon...",
    rx_prompt: "Drop prescription image here",
    loading: "Please wait...",
    error: "A connection error occurred.",
    disclaimer: "Note: This app is for information only and not a substitute for medical advice.",
    visitor_count_label: "Visitor Count:",
  }
};

const arrayBufferToBase64 = (buffer) => {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
};

export default function App() {
  const [currentView, setCurrentView] = useState('qa');
  const [language, setLanguage] = useState('ku');
  const [query, setQuery] = useState('');
  const [response, setResponse] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [imageData, setImageData] = useState(null);
  const [visitorCount, setVisitorCount] = useState(0);
  const [chatHistory, setChatHistory] = useState([]);

  const t = (k) => (UI_TEXT[language] && UI_TEXT[language][k]) || k;

  // ØªÙ†Ø¸ÛŒÙ…Ú©Ø±Ø¯Ù†ÛŒ Ø¦Ø§ÛŒÚ©Û†Ù†ÛŒ Ø¯Û•Ø±Û•Ú©ÛŒ ØªÛ•Ù†Ù‡Ø§ Ø¨Û† Ø³ÛŒØ³ØªÙ…
  useEffect(() => {
    let link = document.querySelector("link[rel~='icon']");
    if (!link) {
      link = document.createElement('link');
      link.rel = 'icon';
      document.getElementsByTagName('head')[0].appendChild(link);
    }
    link.href = APP_ICON_URL;

    let appleIcon = document.querySelector("link[rel='apple-touch-icon']");
    if (!appleIcon) {
      appleIcon = document.createElement('link');
      appleIcon.rel = 'apple-touch-icon';
      document.getElementsByTagName('head')[0].appendChild(appleIcon);
    }
    appleIcon.href = APP_ICON_URL;
  }, []);

  useEffect(() => {
    const initFirebase = async () => {
      try {
        if (typeof __firebase_config === 'undefined') return;
        const config = JSON.parse(__firebase_config);
        if (!config.apiKey) return;
        const app = getApps().length === 0 ? initializeApp(config) : getApps()[0];
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'idoctore-app';

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (u) => {
          if (u) {
            const docRef = doc(db, "artifacts", appId, "public", "data", "app_metrics", "visitor_count");
            onSnapshot(docRef, (s) => setVisitorCount(s.exists() ? s.data().count : 0));
            const key = `visited_${new Date().toDateString()}`;
            if (!localStorage.getItem(key)) {
              setDoc(docRef, { count: increment(1) }, { merge: true }).then(() => localStorage.setItem(key, 'true'));
            }
          }
        });
      } catch (e) { console.error(e); }
    };
    initFirebase();
  }, []);

  const handleAIService = async (mode, customQuery = null) => {
    const activeQuery = customQuery || query;
    if (!activeQuery.trim() && !imageData) return;
    setLoading(true); setError(null); setResponse(null);
    
    let systemPrompt = `You are a professional medical assistant for iDoctors. Answer in ${language.toUpperCase()}.`;
    
    if (mode === 'drug') {
        systemPrompt += ` Focus: Drug Info.`;
    } else if (mode === 'lab') {
        systemPrompt += ` Analyze medical lab test results.`;
    } else if (mode === 'doctors_ai') {
        systemPrompt = `You are a professional doctor. Language: KURDISH.`;
    } else if (mode === 'pregnancy_weeks') {
        systemPrompt = `Pregnancy expert. Answer in Central Kurdish.`;
    }

    const payload = {
        contents: mode === 'doctors_ai' 
            ? [...chatHistory.map(h => ({ role: h.role, parts: [{ text: h.text }] })), { role: 'user', parts: [{ text: activeQuery }] }]
            : [{ parts: [{ text: activeQuery || "Analyze this" }, ...(imageData ? [{ inlineData: imageData }] : [])] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
      const res = await fetch(`${BASE_URL}${MODEL_NAME_FLASH}:generateContent?key=${API_KEY}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      const data = await res.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
      
      if (mode === 'doctors_ai') {
          setChatHistory(prev => [...prev, { role: 'user', text: activeQuery }, { role: 'model', text: aiText }]);
          setQuery('');
      } else {
          setResponse(aiText);
      }
    } catch (e) { setError(t('error')); } finally { setLoading(false); }
  };

  const handleFile = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => setImageData({ data: arrayBufferToBase64(reader.result), mimeType: file.type });
      reader.readAsArrayBuffer(file);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex justify-center overflow-x-hidden" dir={language === 'en' ? 'ltr' : 'rtl'}>
      <style dangerouslySetInnerHTML={{__html: `
        input, textarea, select { font-size: 16px !important; }
        @viewport { width: device-width; zoom: 1.0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
      `}} />

      <div className="w-full max-w-md shadow-2xl min-h-screen flex flex-col border-x border-gray-100 bg-white">
        
        {/* Header - Removed the side icon as requested */}
        <header className={`${PRIMARY_COLOR} pt-10 pb-8 px-6 text-white rounded-b-[40px] shadow-lg relative overflow-hidden`}>
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
          
          <div className="flex justify-between items-center relative z-10">
            {/* Ù†Ø§ÙˆÛŒ Ø¦Û•Ù¾Û•Ú©Û• Ø¨Û ÙˆÛÙ†Û• */}
            <h1 className="text-2xl font-black tracking-tight">
              {t('app_title')}
            </h1>
            
            <div className="flex bg-white/10 backdrop-blur-xl border border-white/20 p-1 rounded-2xl shadow-inner">
              {['ku', 'ar', 'en'].map(l => (
                  <button 
                    key={l} 
                    onClick={() => setLanguage(l)} 
                    className={`
                      relative px-3 py-1.5 text-[10px] font-black rounded-xl transition-all duration-300
                      ${language === l 
                        ? 'bg-white text-teal-800 shadow-md scale-105 z-10' 
                        : 'text-white/60 hover:text-white hover:bg-white/5'
                      }
                    `}
                  >
                      {l.toUpperCase()}
                  </button>
              ))}
            </div>
          </div>
        </header>

        {/* Navigation */}
        <nav className="flex overflow-x-auto px-4 py-4 gap-2 no-scrollbar bg-white sticky top-0 z-10 shadow-sm border-b">
          {Object.keys(VIEW_CONFIG).map(v => (
            <button 
                key={v} onClick={() => { setCurrentView(v); setResponse(null); setQuery(''); setImageData(null); }}
                className={`flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-black transition-all flex items-center gap-2 ${currentView === v ? 'bg-teal-800 text-white shadow-md' : 'bg-gray-100 text-gray-500'}`}
            >
                <span>{VIEW_CONFIG[v].icon}</span> {t(VIEW_CONFIG[v].textKey)}
            </button>
          ))}
        </nav>

        {/* Main Content Area */}
        <main className="flex-grow p-4 space-y-6">
          {/* Drug View */}
          {currentView === 'drug' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-emerald-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-emerald-50 pb-3">
                  <span className="p-2 bg-emerald-100 text-emerald-600 rounded-xl">ğŸ”</span>
                  <h3 className="font-black text-emerald-800 text-sm">{t('drug_search_title')}</h3>
                </div>
                <input type="text" className="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold shadow-inner" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={t('placeholder_drug')} />
                <button onClick={() => handleAIService('drug')} className="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black text-xs">Ú¯Û•Ú•Ø§Ù† âœ¨</button>
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-sky-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-sky-50 pb-3">
                  <span className="p-2 bg-sky-100 text-sky-600 rounded-xl">ğŸ“¸</span>
                  <h3 className="font-black text-sky-800 text-sm">{t('drug_rx_title')}</h3>
                </div>
                <label className="block w-full py-8 bg-sky-50 text-sky-700 rounded-3xl border-2 border-dashed border-sky-200 cursor-pointer text-center">
                  {imageData ? "ÙˆÛÙ†Û•Ú©Û• Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ• âœ…" : t('rx_prompt')}
                  <input type="file" accept="image/*" className="hidden" onChange={handleFile} />
                </label>
                {imageData && <button onClick={() => handleAIService('drug_rx')} className="w-full py-4 bg-sky-600 text-white rounded-2xl font-black text-xs">Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•</button>}
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-amber-100 text-center space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-amber-50 pb-3">
                  <span className="p-2 bg-amber-100 text-amber-600 rounded-xl">ğŸ“</span>
                  <h3 className="font-black text-amber-800 text-sm">{t('drug_pharmacy_title')}</h3>
                </div>
                <p className="text-[11px] font-bold text-gray-500 p-4 bg-amber-50/50 rounded-2xl">{t('pharmacy_status')}</p>
              </div>
            </div>
          )}

          {/* Lab View */}
          {currentView === 'lab' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-indigo-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-indigo-50 pb-3">
                  <span className="p-2 bg-indigo-100 text-indigo-600 rounded-xl">ğŸ”¬</span>
                  <h3 className="font-black text-indigo-800 text-sm">{t('lab_analyze_title')}</h3>
                </div>
                <label className="block w-full py-8 bg-indigo-50 text-indigo-700 rounded-3xl border-2 border-dashed border-indigo-200 cursor-pointer text-center">
                  {imageData ? "âœ… Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•" : t('lab_prompt')}
                  <input type="file" accept="image/*" className="hidden" onChange={handleFile} />
                </label>
                <button onClick={() => handleAIService('lab')} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs">Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙÛ•Ø­Ø³</button>
              </div>
            </div>
          )}

          {/* Pregnancy View */}
          {currentView === 'pregnancy' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[35px] p-6 shadow-md border border-amber-100 space-y-6">
                <input type="date" className="w-full p-5 bg-gray-50 rounded-[25px] border-none font-bold shadow-inner text-center" value={query} onChange={(e) => setQuery(e.target.value)} />
                <button onClick={() => handleAIService('pregnancy_weeks')} className="w-full py-4 bg-amber-500 text-white rounded-2xl font-black text-xs">{t('preg_weeks_btn')}</button>
                <button onClick={() => handleAIService('pregnancy_gender')} className="w-full py-4 bg-pink-500 text-white rounded-2xl font-black text-xs">{t('preg_gender_btn')}</button>
              </div>
            </div>
          )}

          {/* Doctors View */}
          {currentView === 'doctors' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-sky-100 space-y-4">
                <div className="bg-gray-50 rounded-2xl p-4 min-h-[250px] max-h-[350px] overflow-y-auto space-y-3 no-scrollbar">
                   {chatHistory.length === 0 && <div className="text-center py-10 text-gray-400 font-bold text-xs">Ø³ÚµØ§ÙˆØŒ Ú†Û†Ù† Ø¯Û•ØªÙˆØ§Ù†Ù… ÛŒØ§Ø±Ù…Û•ØªÛŒØª Ø¨Ø¯Û•Ù… ÙˆÛ•Ú© Ù¾Ø²ÛŒØ´Ú©ØŸ</div>}
                   {chatHistory.map((chat, i) => (
                    <div key={i} className={`flex ${chat.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] p-3 rounded-2xl text-[11px] font-bold ${chat.role === 'user' ? 'bg-sky-500 text-white' : 'bg-white text-gray-700 border border-sky-50'}`}>
                        {chat.text}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input type="text" className="flex-grow p-4 bg-gray-100 rounded-2xl border-none font-bold text-xs" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•..." />
                  <button onClick={() => handleAIService('doctors_ai')} className="p-4 bg-sky-600 text-white rounded-2xl">ğŸ“¤</button>
                </div>
              </div>
            </div>
          )}

          {/* QA View */}
          {currentView === 'qa' && (
            <div className="space-y-4 animate-in fade-in duration-500">
              <div className="bg-white rounded-[35px] p-6 shadow-md border border-gray-100">
                <textarea className="w-full p-5 bg-gray-50 rounded-[25px] border-none font-bold shadow-inner" rows="4" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={t('tab_qa')} />
                <button onClick={() => handleAIService('qa')} className={`w-full mt-4 py-4 rounded-2xl text-white font-black shadow-lg ${VIEW_CONFIG.qa.button}`}>Ù†Ø§Ø±Ø¯Ù†ÛŒ Ù¾Ø±Ø³ÛŒØ§Ø±</button>
              </div>
            </div>
          )}

          {/* Donation View */}
          {currentView === 'donation' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[35px] p-8 shadow-md border border-red-100 text-center space-y-6">
                <span className="text-5xl block">â¤ï¸</span>
                <div className="p-6 bg-gray-50 rounded-[25px] border border-red-50 space-y-3">
                  <p className="text-xs font-black text-red-600">Ø¨Û† ÛŒØ§Ø±Ù…Û•ØªÛŒØ¯Ø§Ù† Ù„Û• Ú•ÛÚ¯Û•ÛŒ FIB:</p>
                  <div className="text-lg font-black text-teal-700">07503055949</div>
                </div>
              </div>
            </div>
          )}

          {/* Loading and Results */}
          {loading && <div className="text-center p-10 font-black text-teal-600 animate-pulse">{t('loading')}</div>}
          
          {response && (
            <div className="p-6 bg-white border border-teal-50 rounded-[30px] shadow-lg animate-in slide-in-from-bottom-2">
                <p className="text-sm leading-relaxed text-gray-700 whitespace-pre-wrap font-medium">{response}</p>
            </div>
          )}
        </main>

        <footer className="p-8 text-center bg-gray-50 border-t border-gray-100 mt-auto">
            <div className="bg-white inline-flex items-center gap-4 px-4 py-2 rounded-full shadow-sm mb-4">
                <span className="text-[10px] font-black text-gray-400">{t('visitor_count_label')}</span>
                <span className="text-sm font-black text-teal-700">{visitorCount}</span>
            </div>
            <p className="text-[8px] text-gray-400 italic px-6">{t('disclaimer')}</p>
        </footer>
      </div>
    </div>
  );
}

